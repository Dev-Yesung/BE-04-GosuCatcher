<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <style>
        #withdrawLink {
            color: black;
            text-align: left;
            display: block;
        }

        #editLink {
            color: black;
            text-align: left;
            display: block;
        }

        .user_interface {
        }

        button.btn1 {
            position: inherit;
            top: 85px;
            left: 150px;
            width: 1em;
            height: 1em;
            bottom: 0;
            right: 0;
        }
    </style>
    <title>Gosu Catcher</title>
</head>
<body>
<div th:replace="/layout/header.html :: fragment-header"></div>
<div th:replace="/layout/nav.html :: fragment-nav"></div>
<script>
    $(document).ready(function () {
        loadUserInfo();
        loadUserImage();
        $('#withdrawLink').on('click', function (e) {
            e.preventDefault(); // 기본 동작(링크 이동)을 막음
            deleteMember();
        });
    });
</script>

<div class="container d-flex justify-content-center" style="max-width: 750px;">
    <div class="col ">
        <h2>계정 설정</h2>
        <div class="profile-image d-flex justify-content-center my-5">
            <div class="user_interface">
                <div class="my-3">
                    <img src="https://gosu-catcher.s3.ap-northeast-2.amazonaws.com/default.png" id="profile_image" alt="avatar"
                         class="rounded-circle img-fluid" style="width: 100px; position: inherit">
                </div>
                <button class="btn btn-cancel btn-secondary btn-sm btn-block" data-dismiss="modal"
                        type="button" data-toggle="modal" data-target="#exampleModalCenter">
                    사진 등록하기
                </button>
                <button class="btn btn-cancel btn-secondary btn-sm btn-block" data-dismiss="modal"
                        type="button" onclick="setDefaultProfileImage()">
                    기본 이미지로 변경
                </button>

                <div class="modal fade" id="exampleModalCenter" tabindex="-1" role="dialog"
                     aria-labelledby="exampleModalCenterTitle" aria-hidden="true">
                    <div class="modal-dialog modal-dialog-centered" role="document">
                        <div class="modal-content">

                            <input type="file" class="real-upload" accept="image/*" required multiple>
                            <script>
                                const realUpload = document.querySelector('.real-upload');
                                const upload = document.querySelector('.upload');

                                upload.addEventListener('click', () => realUpload.click());
                                realUpload.addEventListener('change', uploadProfileImage)
                            </script>

                        </div>
                    </div>
                </div>


            </div>
        </div>

        <div class="card-body">
            <div class="row">
                <div class="col-sm-3">
                    <p class="mb-0">이름</p>
                </div>
                <div class="col-sm-9">
                    <p class="text-muted mb-0" id="name"> 불러오는 중</p>
                </div>
            </div>
            <hr>
            <div class="row">
                <div class="col-sm-3">
                    <p class="mb-0">이메일</p>
                </div>
                <div class="col-sm-9">
                    <p class="text-muted mb-0" id="email"> 불러오는 중</p>
                </div>
            </div>
            <hr>
            <div class="row">
                <div class="col-sm-3">
                    <p class="mb-0">비밀번호</p>
                </div>
                <div class="col-sm-9">
                    <p class="text-muted mb-0" id="password"> ****** </p>
                </div>
            </div>
            <hr>
            <div class="row">
                <div class="col-sm-3">
                    <p class="mb-0">휴대전화 번호</p>
                </div>
                <div class="col-sm-9">
                    <p class="text-muted mb-0" id="phone"> 휴대폰 번호를 추가해주세요</p>
                </div>
            </div>
            <hr>
            <br>
            <div class="row">
                <div class="col-sm-3">
                    <button type="button" class="btn btn-light" id="withdrawLink" onclick="deleteMember()">
                        회원 탈퇴
                    </button>
                </div>
                <div class="col-sm-3">
                    <button type="button" class="btn btn-light" data-toggle="modal" data-target="#exampleModal"
                            data-whatever="@mdo">회원정보 수정
                    </button>
                </div>


                <div class="modal fade" id="exampleModal" tabindex="-1" role="dialog"
                     aria-labelledby="exampleModalLabel" aria-hidden="true">
                    <div class="modal-dialog" role="document">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title" id="exampleModalLabel">회원정보 수정</h5>
                                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                    <span aria-hidden="true">&times;</span>
                                </button>
                            </div>
                            <div class="modal-body">
                                <form>
                                    <div class="form-group">
                                        <label for="inputPhoneNumber">핸드폰 번호를 숫자만 입력해주세요(11자).</label>
                                        <input type="text" class="form-control" id="inputPhoneNumber"
                                               placeholder="01012341234">
                                    </div>
                                    <div class="form-group">
                                        <label for="inputPassword">비밀번호를 입력하세요</label>
                                        <input type="password" class="form-control" id="inputPassword"
                                               placeholder="5자리 이상 입력해주세요">
                                    </div>
                                </form>
                            </div>
                            <div class="modal-footer">
                                <button type="submit" class="btn btn-light" onclick="modifyUserInfo()"
                                        data-dismiss="modal">완료
                                </button>
                            </div>
                        </div>
                    </div>
                </div>


            </div>
            <hr>
        </div>
    </div>
</div>
<footer th:replace="/layout/footer.html :: fragment-footer"></footer>
<script>
    function modifyUserInfo() {
        const token = 'bearer ' + localStorage.getItem('accessToken');

        const path = '/api/v1/members/profile/';

        if(document.getElementById('inputPhoneNumber').value.length !== 11){
            window.alert("핸드폰 번호를 숫자만 11자로 입력해주세요")
            return;
        }

        if(document.getElementById('inputPassword').value.length < 5){
            window.alert("비밀번호를 5자 이상 입력해주세요")
            return;
        }


        const requestBody = JSON.stringify({
            name: $('#name').text(),
            password: document.getElementById('inputPassword').value,
            phoneNumber: document.getElementById('inputPhoneNumber').value,
        });

        const request = {
            method: 'PATCH',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': token,
            },
            body: requestBody
        }


        fetch(path, request)
            .then(() => window.alert("수정되었습니다."))
            .catch(() => window.alert("조건에 맞게 다시 입력해주세요"));
    }

    function loadUserInfo() {
        let token = 'bearer ' + localStorage.getItem('accessToken');
        $.ajax({
            url: '/api/v1/members/profile/',
            method: 'GET',
            dataType: 'json',
            headers: {
                'Authorization': token,
            },
            success: function (data) {
                $('#name').text(data.name);
                $('#email').text(data.email);
                $('#phone').text(data.phoneNumber);
            },
            error: function () {
                window.alert('회원 정보 조회에 실패했습니다. 새로고침 바랍니다.')
            }
        });
    }

    function loadUserImage() {
        let token = 'bearer ' + localStorage.getItem('accessToken');
        $.ajax({
            url: '/api/v1/members/profile/images',
            method: 'GET',
            dataType: 'json',
            headers: {
                'Authorization': token,
            },
            success: function (data) {
                $('#profile_image').text(data.filenames[0]);
            },
            error: function () {
                window.alert('회원 프로필 이미지 조회에 실패했습니다. 새로고침 바랍니다.')
            }
        });
    }

    function loadFile(input) {
        let memberId = 1;
        $.ajax({
            url: '/api/v1/members/profile/images/' + memberId,
            method: 'POST',
            dataType: 'multipart'
        });
        // var file = input.files[0];	//선택된 파일 가져오기
        //
        // //미리 만들어 놓은 div에 text(파일 이름) 추가
        // var name = document.getElementById('fileName');
        // name.textContent = file.name;
        //
        // //새로운 이미지 div 추가
        // var newImage = document.createElement("img");
        // newImage.setAttribute("class", 'img');
        //
        // //이미지 source 가져오기
        // newImage.src = URL.createObjectURL(file);
        //
        // newImage.style.width = "70%";
        // newImage.style.height = "70%";
        // newImage.style.visibility = "hidden";   //버튼을 누르기 전까지는 이미지를 숨긴다
        // newImage.style.objectFit = "contain";
        //
        // //이미지를 image-show div에 추가
        // var container = document.getElementById('image-show');
        // container.appendChild(newImage);
    }

    function setDefaultProfileImage() {
        const token = sessionStorage.getItem('Authorization');
        fetch('/api/v1/members/profile/images', {
            method: 'DELETE',
            headers: {
                'Authorization': token
            }
        }).then(response => {
            if (response.ok) {
                alert('프로필 이미지가 기본 이미지로 변경되었습니다.');
            } else {
                alert('프로필 이미지 변경 중 오류가 발생했습니다.');
            }
        });
    }

    function deleteMember() {
        let token = 'bearer ' + localStorage.getItem('accessToken');
        $.ajax({
            url: '/api/v1/members',
            method: 'DELETE',
            headers: {
                'Authorization': token,
            },
            success: function () {
                window.location.href = '/gosu-catcher';
            },
            error: function () {
                alert('탈퇴 중 오류가 발생했습니다. 재시도해 주시기를 바랍니다.');
            }
        });
    }


    function uploadProfileImage(input) {
        let file = input.currentTarget.files;

        const token = sessionStorage.getItem('Authorization');


        let formData = new FormData();
        formData.append('file', file.files[0]);

        fetch('/api/v1/members/profile/images', {
            method: 'POST',
            headers: {
                'Authorization': token
            },
            body: formData
        }).then(response => response.json()).then(data => {
            alert('프로필 이미지가 성공적으로 업로드되었습니다.');
        }).catch(error => {
            alert('프로필 이미지 업로드 중 오류가 발생했습니다.');
        });
    }
</script>
</body>
</html>
